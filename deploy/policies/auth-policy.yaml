# AuthPolicy — API key authentication for all tenants
#
# Validates API keys stored as Kubernetes Secrets with label app=token-labs.
# Clients authenticate with: Authorization: Bearer <api_key>
# Kuadrant's AuthPolicy discovers secrets via label selector in kuadrant-system ns.
#
# After validation, enriches the request context with:
#   auth.identity.groups  → tier (free | pro | enterprise) from Secret annotation
#   auth.identity.userid  → unique tenant ID from Secret annotation
# These are consumed by RateLimitPolicy and TokenRateLimitPolicy.
apiVersion: kuadrant.io/v1
kind: AuthPolicy
metadata:
  name: token-labs-auth
  namespace: token-labs
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: token-labs-gateway

  rules:
    authentication:
      api-key-tenants:
        apiKey:
          selector:
            matchLabels:
              app: token-labs
        credentials:
          authorizationHeader:
            prefix: "Bearer"

    response:
      success:
        filters:
          identity:
            json:
              properties:
                groups:
                  selector: auth.identity.metadata.annotations.kuadrant\.io/groups
                userid:
                  selector: auth.identity.metadata.annotations.secret\.kuadrant\.io/user-id

    authorization:
      allow-tiers:
        opa:
          rego: |
            groups := split(object.get(input.auth.identity.metadata.annotations, "kuadrant.io/groups", ""), ",")
            allow { groups[_] == "free" }
            allow { groups[_] == "pro" }
            allow { groups[_] == "enterprise" }
