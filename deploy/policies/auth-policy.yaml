# AuthPolicy â€” API key authentication for all tenants
#
# Validates API keys stored as Kubernetes Secrets with label app=token-labs.
# Extracts tenant tier (groups) and user ID from Secret annotations.
# These are made available to RateLimitPolicy and TokenRateLimitPolicy
# via auth.identity.groups and auth.identity.userid.
apiVersion: kuadrant.io/v1
kind: AuthPolicy
metadata:
  name: token-labs-auth
  namespace: token-labs
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: token-labs-gateway

  rules:
    # Authentication: validate API key from Authorization header
    authentication:
      api-key-tenants:
        apiKey:
          selector:
            matchLabels:
              app: token-labs
        credentials:
          authorizationHeader:
            prefix: "Bearer"  # Accept: Authorization: Bearer <api_key>

    # Response: enrich the request context with tenant metadata
    response:
      success:
        filters:
          identity:
            json:
              properties:
                # Extract tier/group from Secret annotation
                groups:
                  selector: auth.identity.metadata.annotations.kuadrant\.io/groups
                # Extract tenant ID from Secret annotation
                userid:
                  selector: auth.identity.metadata.annotations.secret\.kuadrant\.io/user-id

    # Authorization: allow only recognized tiers
    authorization:
      allow-tiers:
        opa:
          rego: |
            groups := split(object.get(input.auth.identity.metadata.annotations, "kuadrant.io/groups", ""), ",")
            allow { groups[_] == "free" }
            allow { groups[_] == "pro" }
            allow { groups[_] == "enterprise" }
