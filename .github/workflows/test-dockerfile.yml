name: Test Dockerfile on DGX Spark

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'Dockerfile'
      - '.github/workflows/test-dockerfile.yml'

permissions:
  contents: read

jobs:
  test-build:
    runs-on: [self-hosted, DGX-Spark]
    env:
      TEST_TAG: vllm-test:pr-${{ github.event.pull_request.number || 'manual' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          docker system prune -af --volumes || true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (test only)
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/arm64
          push: false
          load: true
          tags: ${{ env.TEST_TAG }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
        env:
          DOCKER_BUILD_SUMMARY: true
          DOCKER_BUILD_RECORD_UPLOAD: false

      - name: Test vLLM installation
        run: |
          docker run --rm ${{ env.TEST_TAG }} --version || \
          docker run --rm ${{ env.TEST_TAG }} vllm --version || \
          docker run --rm --entrypoint python ${{ env.TEST_TAG }} -c "import vllm; import lmcache; print(f'vLLM: {vllm.__version__}'); print(f'LMCache: {lmcache.__version__}')"

      - name: Test vLLM serve command (dry run)
        run: |
          # Test that the entrypoint works with --help
          docker run --rm ${{ env.TEST_TAG }} --help

      - name: Cleanup test image
        if: always()
        run: |
          docker rmi ${{ env.TEST_TAG }} || true

      - name: Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ✅ Docker Build Test Complete
          
          The Dockerfile has been successfully built and tested on DGX Spark (ARM64).
          
          **Tests Performed:**
          - ✅ Docker image builds successfully
          - ✅ vLLM and LMCache packages are installed
          - ✅ vLLM serve command is available
          
          **Platform:** linux/arm64 (Grace Hopper)
          **Image Size:** See build logs above
          EOF
